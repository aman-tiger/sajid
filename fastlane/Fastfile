default_platform(:ios)

platform :ios do
  lane :screenshots do |options|
    version = options[:version] || "2.1.0"

    snapshot(
      output_directory: "./releases/#{version}/listing/screenshots/raw",
      clear_previous_screenshots: true
    )
  end

  lane :frame_screenshots do |options|
    version = options[:version] || "2.1.0"
    variant = options[:variant] || "A"
    raw_path = "./releases/#{version}/listing/screenshots/raw"

    frameit(path: raw_path)

    sh("mkdir -p ./releases/#{version}/listing/screenshots/framed/#{variant}")
    sh("find #{raw_path} -name '*_framed.png' | while read f; do rel=$(echo $f | sed 's|#{raw_path}/||'); dir=$(dirname ./releases/#{version}/listing/screenshots/framed/#{variant}/$rel); mkdir -p $dir; mv $f $dir/; done")
  end

  lane :upload_listing do |options|
    version = options[:version] || "2.1.0"
    variant = options[:variant] || "A"

    meta_src = "./releases/#{version}/listing/metadata"
    screens_src = "./releases/#{version}/listing/screenshots/framed/#{variant}"

    sh("cp -R #{meta_src}/ ./fastlane/metadata/")
    sh("cp -R #{screens_src}/ ./fastlane/screenshots/")

    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("ASC_KEY_ID"),
      issuer_id: ENV.fetch("ASC_ISSUER_ID"),
      key_content: ENV.fetch("ASC_PRIVATE_KEY"),
      is_key_content_base64: true
    )

    deliver(
      api_key: api_key,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots",
      submit_for_review: false,
      force: true,
      skip_binary_upload: true
    )

    sh("rm -rf ./fastlane/metadata ./fastlane/screenshots")
  end

  lane :full_listing do |options|
    version = options[:version] || "2.1.0"
    variant = options[:variant] || "A"

    screenshots(version: version)
    frame_screenshots(version: version, variant: variant)
    upload_listing(version: version, variant: variant)
  end
end
