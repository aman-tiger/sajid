name: Android AAB (Release)

on:
  workflow_dispatch:
    inputs:
      track:
        description: Google Play track
        required: true
        default: internal
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      release_status:
        description: Google Play release status
        required: true
        default: completed
        type: choice
        options:
          - completed
          - draft
          - inProgress
          - halted

jobs:
  build-aab:
    runs-on: ubuntu-latest
    env:
      ANDROID_PACKAGE_NAME: com.hidavo.neverever

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Restore Firebase Android config
        env:
          ANDROID_GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.ANDROID_GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          mkdir -p android/app
          echo "$ANDROID_GOOGLE_SERVICES_JSON_BASE64" | base64 --decode > android/app/google-services.json

      - name: Prepare Android signing files
        env:
          ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          mkdir -p android/app
          echo "$ANDROID_KEYSTORE_FILE" | base64 --decode > android/app/upload-keystore.jks

          cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=app/upload-keystore.jks
          EOF

          keytool -list -keystore android/app/upload-keystore.jks -storepass "$ANDROID_KEYSTORE_PASSWORD" > /tmp/keystore_aliases.txt
          if ! grep -Fq "$ANDROID_KEY_ALIAS" /tmp/keystore_aliases.txt; then
            echo "Signing preflight failed: alias '$ANDROID_KEY_ALIAS' not found in keystore"
            cat /tmp/keystore_aliases.txt
            exit 1
          fi

      - name: Build signed AAB
        run: flutter build appbundle --release --build-number=${{ github.run_number }}

      - name: Locate AAB
        id: locate_aab
        run: |
          AAB_PATH=$(find build/app/outputs/bundle/release -name "*.aab" | head -n 1)
          if [ -z "$AAB_PATH" ]; then
            echo "AAB not found"
            exit 1
          fi
          echo "aab_path=$AAB_PATH" >> "$GITHUB_OUTPUT"
          ls -lh "$AAB_PATH"

      - name: Prepare Google Play service account
        id: prepare_play
        env:
          ANDROID_SERVICE_ACCOUNT: ${{ secrets.ANDROID_SERVICE_ACCOUNT }}
        run: |
          SERVICE_ACCOUNT_PATH="$RUNNER_TEMP/google-play-service-account.json"

          if echo "$ANDROID_SERVICE_ACCOUNT" | jq -e . >/dev/null 2>&1; then
            echo "$ANDROID_SERVICE_ACCOUNT" > "$SERVICE_ACCOUNT_PATH"
          else
            echo "$ANDROID_SERVICE_ACCOUNT" | base64 --decode > "$SERVICE_ACCOUNT_PATH"
          fi

          if ! jq -e '.type == "service_account" and .client_email and .private_key' "$SERVICE_ACCOUNT_PATH" >/dev/null; then
            echo "Invalid Google Play service account JSON"
            exit 1
          fi

          echo "service_account_path=$SERVICE_ACCOUNT_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: ${{ steps.locate_aab.outputs.aab_path }}
          retention-days: 30

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ steps.prepare_play.outputs.service_account_path }}
          packageName: ${{ env.ANDROID_PACKAGE_NAME }}
          releaseFiles: ${{ steps.locate_aab.outputs.aab_path }}
          track: ${{ inputs.track }}
          status: ${{ inputs.release_status }}

      - name: Clean up
        if: always()
        run: |
          rm -f android/key.properties
          rm -f android/app/upload-keystore.jks
